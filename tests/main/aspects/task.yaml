summary: Check the aspects API

# ubuntu-14.04-64's curl doesn't support --unix-socket
systems: [-ubuntu-14.04-*]

prepare: |
  snap install test-snapd-curl --edge --devmode
  snap alias test-snapd-curl.curl curl
  snap install --edge jq

execute: |
  # write a value
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XPOST -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "ssid", "value": "canonical"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 200

  # read the same value
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XGET -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "ssid"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 200
  jq -r '.result' < response.txt | MATCH "canonical"

  # delete it
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XPOST -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "ssid"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 200

  # check it was deleted
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XGET -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "ssid"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 404
  jq -r '.result.message' < response.txt | MATCH 'cannot get field "ssid": no value was found under "wifi"'

  # write values using a placeholder access
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XPOST -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "private.my-company", "value": "my-config"}' -H 'Content-Type: application/json' > response.txt
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XPOST -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "private.your-company", "value": "your-config"}' -H 'Content-Type: application/json' > response.txt

  # check first value
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XGET -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "private.my-company"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 200
  jq -r '.result' < response.txt | MATCH "my-config"

  # delete it
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XPOST -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "private.my-company"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 200

  # check it was deleted
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XGET -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "private.my-company"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 404
  jq -r '.result.message' < response.txt | MATCH 'cannot get field "private.my-company": no value was found under "wifi.my-company"'

  # check second value remains
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XGET -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "private.your-company"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 200
  jq -r '.result' < response.txt | MATCH "your-config"
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XPOST -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "private.your-company"}' -H 'Content-Type: application/json' > response.txt

  # write a list
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XPOST -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "ssids", "value": ["one", 2]}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 200

  # read the same value
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XGET -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "ssids"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 200
  jq -r '.result' < response.txt | MATCH '["one", 2]'

  # check read-only access control works
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XPOST -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "status", "value": "foo"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 403
  jq -r '.result.message' < response.txt | MATCH 'cannot write field "status": only supports read access'

  # check write-only access control works
  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XPOST -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "password", "value": "foo"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 200

  curl -sS --unix-socket /run/snapd.socket localhost/v2/aspects -XGET -d '{"account": "system", "bundle": "network", "aspect": "wifi-setup", "field": "password"}' -H 'Content-Type: application/json' > response.txt
  jq -r '."status-code"' < response.txt | MATCH 403
  jq -r '.result.message' < response.txt | MATCH 'cannot read field "password": only supports write access'
